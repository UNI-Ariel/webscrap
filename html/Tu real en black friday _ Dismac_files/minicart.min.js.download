define(['uiComponent','Magento_Customer/js/customer-data','jquery','ko','underscore','sidebar','mage/translate','mage/dropdown','mage/url'],function(Component,customerData,$,ko,_,sidebar,translate,dropdown,url){'use strict';var sidebarInitialized=false,addToCartCalls=0,miniCart;miniCart=$('[data-block=\'minicart\']');function initSidebar(){if(miniCart.data('mageSidebar')){miniCart.sidebar('update');}
if(!$('[data-role=product-item]').length){return false;}
miniCart.trigger('contentUpdated');if(sidebarInitialized){return false;}
sidebarInitialized=true;miniCart.sidebar({'targetElement':'div.block.block-minicart','url':{'checkout':window.checkout.shoppingCartUrl,'update':window.checkout.updateItemQtyUrl,'remove':window.checkout.removeItemUrl,'loginUrl':window.checkout.customerLoginUrl,'isRedirectRequired':window.checkout.isRedirectRequired},'button':{'checkout':'#top-cart-btn-checkout','remove':'#mini-cart a.action.delete','close':'#btn-minicart-close'},'showcart':{'parent':'span.counter','qty':'span.counter-number','label':'span.counter-label'},'minicart':{'list':'#mini-cart','content':'#minicart-content-wrapper','qty':'div.items-total','subtotal':'div.subtotal span.price','maxItemsVisible':window.checkout.minicartMaxItemsVisible},'item':{'qty':':input.cart-item-qty','button':':button.update-cart-item'},'confirmMessage':$.mage.__('Are you sure you would like to remove this item from the shopping cart?')});}
miniCart.on('dropdowndialogopen',function(){initSidebar();});return Component.extend({shoppingCartUrl:window.checkout.shoppingCartUrl,maxItemsToDisplay:window.checkout.maxItemsToDisplay,cart:{},initialize:function(){var self=this,cartData=customerData.get('cart');this.update(cartData());cartData.subscribe(function(updatedCart){addToCartCalls--;this.isLoading(addToCartCalls>0);sidebarInitialized=false;this.update(updatedCart);initSidebar();},this);$('[data-block="minicart"]').on('contentLoading',function(){addToCartCalls++;self.isLoading(true);});if(cartData().website_id!==window.checkout.websiteId||cartData().store_id!==window.checkout.storeId){customerData.reload(['cart'],false);}
return this._super();},isLoading:ko.observable(false),initSidebar:initSidebar,closeMinicart:function(){$('[data-block="minicart"]').find('[data-role="dropdownDialog"]').dropdownDialog('close');},closeSidebar:function(){var minicart=$('[data-block="minicart"]');minicart.on('click','[data-action="close"]',function(event){event.stopPropagation();minicart.find('[data-role="dropdownDialog"]').dropdownDialog('close');});return true;},getItemRenderer:function(productType){return this.itemRenderer[productType]||'defaultRenderer';},update:function(updatedCart){_.each(updatedCart,function(value,key){if(!this.cart.hasOwnProperty(key)){this.cart[key]=ko.observable();}
this.cart[key](value);},this);this.compareCart();},compareCart:function(){let cartDismac=this.convertCartToOld();if(window.localStorage.oldCart!=null){let oldCart=JSON.parse(window.localStorage.oldCart);if(cartDismac.length==0){if(oldCart.length>0){this.cartProductsNewEvent(oldCart,false);window.localStorage.oldCart=JSON.stringify(cartDismac);}}else{oldCart=this.removeProductOld(cartDismac,oldCart);oldCart=this.compareCarOldCart(cartDismac,oldCart);window.localStorage.oldCart=JSON.stringify(oldCart);}}else{window.localStorage.oldCart=JSON.stringify(cartDismac);this.cartProductsNewEvent(cartDismac,true);}},ifExistIdProduct:function(Cart,ID){for(let index=0;index<Cart.length;index++){if(Cart[index]["id"]==ID){return Cart[index];}}
return null;},compareCarOldCart:function(Cart,OldCart){let NewOld=[];for(let index=0;index<Cart.length;index++){let item=this.ifExistIdProduct(OldCart,Cart[index]["id"]);if(item!=null){if(Cart[index]["quantity"]!=item.quantity||Cart[index]["price"]!=item.price){this.emitToTagManagerCartREMOVE(item);item=Cart[index];this.emitToTagManagerCartADD(item);}
NewOld.push(item);}}
return NewOld;},removeProductOld:function(Cart,OldCart){for(let index=0;index<OldCart.length;index++){if(this.ifExistIdProduct(Cart,OldCart[index]["id"])==null){this.emitToTagManagerCartREMOVE(OldCart[index]);}}
return this.addProductOld(Cart,OldCart);},addProductOld:function(Cart,OldCart){for(let index=0;index<Cart.length;index++){if(this.ifExistIdProduct(OldCart,Cart[index]["id"])==null){OldCart.push(Cart[index]);this.emitToTagManagerCartADD(Cart[index]);}}
return OldCart;},cartProductsNewEvent:function(Cart,add){for(let index=0;index<Cart.length;index++){if(add){this.emitToTagManagerCartADD(Cart[index]);}else{this.emitToTagManagerCartREMOVE(Cart[index]);}}},getDataIDCart:function(){if(this.cart!=null){if(this.cart["data_id"]!=null){if(this.cart["data_id"]["_latestValue"]!=null){return this.cart["data_id"]["_latestValue"];}}}
return"0000-0000"},emitToTagManagerCartADD:function(product){if("gtag"in window){window.gtag("event","add_to_cart",{items:[{item_name:product.name,item_id:product.id,price:this.priceProduct(product.quantity,product.price),value:this.priceProduct(product.quantity,product.price),item_brand:product.brand,item_category:product.category,index:1,quantity:product.quantity,currency:"USD"}]});}},priceProduct:function(qty,price){return parseFloat(qty)*parseFloat(price);},getDateTime:function(){var date=new Date();var dateStr=date.getFullYear()+"-"+("00"+(date.getMonth()+1)).slice(-2)+"-"+
("00"+date.getDate()).slice(-2)+" "+("00"+date.getHours()).slice(-2)+":"+
("00"+date.getMinutes()).slice(-2)+":"+("00"+date.getSeconds()).slice(-2);return dateStr;},emitToTagManagerCartREMOVE:function(product){if("gtag"in window){deleteHistoryProductPopUp(product.id);window.gtag("event","remove_from_cart",{items:[{item_name:product.name,item_id:product.id,price:this.priceProduct(product.quantity,product.price),value:this.priceProduct(product.quantity,product.price),item_brand:product.brand,item_category:product.category,index:1,quantity:product.quantity,currency:"USD"}]});}},convertCartToOld:function(){let cartNew=[];if(this.cart!=null){if(this.cart["items"]!=null){if(this.cart["items"]["_latestValue"]!=null){let cartArray=this.cart["items"]["_latestValue"];for(let index=0;index<cartArray.length;index++){cartNew.push({id:cartArray[index]["product_sku"],name:cartArray[index]["product_name"],price:cartArray[index]["product_price_value"],quantity:cartArray[index]["qty"],brand:cartArray[index]["product_brand"],category:cartArray[index]["product_category"]});}}}}
return cartNew;},getCartParam:function(name){if(!_.isUndefined(name)){if(!this.cart.hasOwnProperty(name)){this.cart[name]=ko.observable();}}
$('#top-cart-btn-checkout-multishipping').click(function(event){event.stopPropagation();$('body').trigger('processStart');var urlLink=url.build('multishipping/checkout');location.href=urlLink;});return this.cart[name]();},getCartItems:function(){var items=this.getCartParam('items')||[];items=items.slice(parseInt(-this.maxItemsToDisplay,10));return items;},incrementClickCounter:function(item_id,action){let qty=this.getValueToInput(item_id);if(qty!=null){qty=parseInt(qty);if(action=="sum"){qty+=1;this.setValueToInput(item_id,qty);}else if(action=="min"){qty-=1;this.setValueToInput(item_id,qty);}}},getValueToInput:function(id){let input_id='#qty-cart-'+id;if($(input_id).length>0){return parseInt($(input_id).text());}else{return null;}},deleteToCartItem:function(id){$.ajax({url:window.checkout.updateItemQtyUrl,type:'POST',dataType:'json',showLoader:true,data:{"item_id":id},beforeSend:function(){},success:function(data,status,xhr){},error:function(xhr,status,errorThrown){}});},setValueToInput:function(id,qty){let span_qty='#qty-cart-'+id;$.ajax({url:window.checkout.updateItemQtyUrl,type:'POST',dataType:'json',showLoader:true,data:{"item_id":id,"item_qty":qty},beforeSend:function(){},success:function(data,status,xhr){$(span_qty).text(qty);},error:function(xhr,status,errorThrown){}});},renderDefaultHtml:function(id){$('#image-cart-'+id).mouseenter(function(event){if($('#content-float-'+id).css('position')=='absolute'){$('#content-float-'+id).css('display','block').css('position','fixed').css('top',(event.clientY-20)+"px");}});$('#content-cart-'+id).mouseleave(function(){$('#content-float-'+id).css('display','none').css('position','absolute').css('top','20px');});return"<h1 class='hiddenCart'></h1>";},addCommaName:function(name){return name.replace("&quot;",'"');},getMoneyFormat:function(price){return window.setMoneyString(price);},getCartParamUnsanitizedHtml:function(name){if(!_.isUndefined(name)){if(!this.cart.hasOwnProperty(name)){this.cart[name]=ko.observable();}}
return this.cart[name]();},getCartLineItemsCount:function(){var items=this.getCartParam('items')||[];return parseInt(items.length,10);}});});