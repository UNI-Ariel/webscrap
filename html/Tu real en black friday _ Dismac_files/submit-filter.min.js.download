define(['jquery','mage/storage','Mageplaza_LayeredNavigationUltimate/js/model/loader','ko','mage/apply/main'],function($,storage,loader,ko,mage){'use strict';var productContainer=$('#layer-product-list'),layerContainer=$('.layered-filter-block-container'),quickViewContainer=$('#mpquickview-popup'),toolbarAmount=$('#toolbar-amount'),isLoading=false;return function(layer,listEl){if(isLoading){return;}
var nextItem=productContainer.find('.pages-item-next');if(!nextItem.length){return;}
var submitUrl=nextItem.find('a.action.next').first().prop('href');if(!layer.checkUrl(submitUrl)){return;}
loader.startLoader();isLoading=true;return storage.post(submitUrl).done(function(response){var productsHtml=response.products;if(!productsHtml){productsHtml=$(response).find("#layer-product-list").html();}
if(productsHtml){if(response.navigation){layerContainer.html(response.navigation);}
if(response.quickview){quickViewContainer.html(response.quickview);}
var products=$('<div>'+productsHtml+'</div>');listEl.find('li').last().after(products.find('.items.product-items').html().trim());var pages=$("ul.items.pages-items");pages.html(products.find('ul.items.pages-items').html());var productCount=productContainer.find('li.item.product.product-item');toolbarAmount.find('.toolbar-number').first().next().html(productCount.length);var listPro=[];products.find('.items.product-items li').each(function(){let proId=$(this).find('.product-item-info').attr('id');if(proId)
listPro.push(proId);})
for(let i=0;i<listPro.length;i++){let pro=$('#'+listPro[i]);ko.cleanNode(pro[0]);pro.applyBindings();}
if(mage){mage.apply();}
$("form[data-role='tocart-form']").catalogAddToCart();}}).fail(function(){window.location.reload();}).always(function(){loader.stopLoader();isLoading=false;});};});